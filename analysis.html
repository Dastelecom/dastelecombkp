<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <title>Analytics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      font-family: 'Outfit', sans-serif;
      background-color: #fafbfc;
      background-image:
        radial-gradient(at 100% 0%, rgba(59, 130, 246, 0.05) 0px, transparent 50%),
        radial-gradient(at 0% 100%, rgba(244, 244, 245, 1) 0px, transparent 50%);
      color: #1e293b;
      min-height: 100vh;

      /* Smooth Page Load */
      opacity: 0;
      animation: pageLoad 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    @keyframes pageLoad {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow:
        0 4px 6px -1px rgba(0, 0, 0, 0.02),
        0 10px 15px -3px rgba(0, 0, 0, 0.04),
        0 0 0 1px rgba(0, 0, 0, 0.02);
    }

    .metric-card {
      background: white;
      border: 1px solid #f1f5f9;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow:
        0 20px 25px -5px rgba(0, 0, 0, 0.05),
        0 8px 10px -6px rgba(0, 0, 0, 0.01);
      border-color: #cbd5e1;
    }

    .enhanced-card {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid #e2e8f0;
      border-radius: 1rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .enhanced-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      border-color: #cbd5e1;
    }

    .stat-number {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    .loading-spinner {
      border: 3px solid #f1f5f9;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .trend-up {
      color: #10b981;
      font-weight: 600;
    }

    .trend-down {
      color: #ef4444;
      font-weight: 600;
    }

    .navbar {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid #f1f5f9;
    }

    .status-select {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      color: #334155;
      font-size: 0.75rem;
      padding: 0.375rem 0.5rem;
      border-radius: 0.5rem;
      transition: all 0.2s ease;
      cursor: pointer;
      font-weight: 600;
    }

    .status-select:hover {
      border-color: #cbd5e1;
      background: #f1f5f9;
    }

    .status-select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    .search-enhanced {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      transition: all 0.2s ease;
      color: #334155;
    }

    .search-enhanced:focus {
      background: white;
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.05);
      outline: none;
    }

    .live-indicator::before {
      content: '';
      position: absolute;
      top: -2px;
      right: -8px;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      box-shadow: 0 0 0 2px white;
      animation: live-pulse 2s infinite;
    }

    @keyframes live-pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.5;
        transform: scale(1.2);
      }
    }
  </style>
</head>

<body class="text-slate-600 antialiased">
  <!-- Navigation Header -->
  <nav class="navbar sticky top-0 z-50 px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <a href="main.html"
          class="group flex items-center text-slate-500 hover:text-slate-800 transition-colors bg-white border border-slate-200 rounded-full px-4 py-2 hover:border-slate-300 hover:shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-slate-400 group-hover:text-slate-600"
            fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span class="font-medium text-sm">Dashboard</span>
        </a>
        <h1 class="text-xl font-bold text-slate-800">Analytics</h1>
      </div>
      <div class="text-xs font-bold text-slate-400 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
        <span id="current-time"></span>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-8">
    <!-- Key Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Total Revenue -->
      <div class="metric-card rounded-2xl p-6 relative overflow-hidden group">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
          <i class="fas fa-rupee-sign text-6xl text-blue-600"></i>
        </div>
        <div class="relative z-10">
          <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Total Revenue</p>
          <p class="text-3xl font-black text-slate-800 tracking-tight" id="total-revenue">₹0</p>
          <div class="flex items-center mt-2 text-xs font-bold">
            <span class="trend-up bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full flex items-center">
              <i class="fas fa-arrow-up mr-1 text-[10px]"></i> <span id="revenue-trend">0%</span>
            </span>
            <span class="text-slate-400 ml-2">vs last month</span>
          </div>
        </div>
      </div>

      <!-- Total Invoices -->
      <div class="metric-card rounded-2xl p-6 relative overflow-hidden group">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
          <i class="fas fa-file-invoice text-6xl text-purple-600"></i>
        </div>
        <div class="relative z-10">
          <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Total Invoices</p>
          <p class="text-3xl font-black text-slate-800 tracking-tight" id="total-invoices">0</p>
          <div class="flex items-center mt-2 text-xs font-bold">
            <span class="trend-up bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full flex items-center">
              <i class="fas fa-arrow-up mr-1 text-[10px]"></i> <span id="invoice-trend">0%</span>
            </span>
            <span class="text-slate-400 ml-2">vs last month</span>
          </div>
        </div>
      </div>

      <!-- Phones Sold -->
      <div class="metric-card rounded-2xl p-6 relative overflow-hidden group">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
          <i class="fas fa-mobile-alt text-6xl text-indigo-600"></i>
        </div>
        <div class="relative z-10">
          <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Phones Sold</p>
          <p class="text-3xl font-black text-slate-800 tracking-tight" id="phones-sold">0</p>
          <div class="flex items-center mt-2 text-xs font-bold">
            <span class="trend-up bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full flex items-center">
              <i class="fas fa-arrow-up mr-1 text-[10px]"></i> <span id="phones-trend">0%</span>
            </span>
            <span class="text-slate-400 ml-2">vs last month</span>
          </div>
        </div>
      </div>

      <!-- Average Order Value -->
      <div class="metric-card rounded-2xl p-6 relative overflow-hidden group">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
          <i class="fas fa-chart-line text-6xl text-orange-600"></i>
        </div>
        <div class="relative z-10">
          <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Avg Order Value</p>
          <p class="text-3xl font-black text-slate-800 tracking-tight" id="avg-order">₹0</p>
          <div class="flex items-center mt-2 text-xs font-bold">
            <span class="trend-up bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full flex items-center">
              <i class="fas fa-arrow-up mr-1 text-[10px]"></i> <span id="avg-trend">0%</span>
            </span>
            <span class="text-slate-400 ml-2">vs last month</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Section -->
    <div class="glass rounded-[1.5rem] p-8 mb-8 border border-white">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center">
            <i class="fas fa-download text-sm"></i>
          </span>
          Monthly Reports & Downloads
        </h3>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Monthly Report Selector -->
        <div class="bg-white rounded-xl p-5 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
          <h4 class="text-slate-700 font-bold mb-4 flex items-center gap-2 text-sm">
            <i class="fas fa-calendar-alt text-slate-400"></i>
            Monthly Report
          </h4>
          <div class="space-y-3">
            <select id="monthSelector"
              class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all appearance-none">
              <!-- Options will be populated by JavaScript -->
            </select>
            <button onclick="generateMonthlyReport()"
              class="w-full bg-slate-900 hover:bg-slate-800 text-white px-4 py-2.5 rounded-xl text-sm font-bold transition-all shadow-lg shadow-slate-900/10 active:scale-95 flex items-center justify-center gap-2">
              <i class="fas fa-chart-bar"></i>
              Generate Report
            </button>
          </div>
        </div>

        <!-- Sales Report Download -->
        <div class="bg-white rounded-xl p-5 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
          <h4 class="text-slate-700 font-bold mb-4 flex items-center gap-2 text-sm">
            <i class="fas fa-file-csv text-slate-400"></i>
            Export Data
          </h4>
          <div class="space-y-3">
            <div class="text-xs text-slate-400 mb-2 font-medium">
              Download complete sales history
            </div>
            <div class="flex gap-2">
              <button onclick="downloadSalesReport('csv')"
                class="flex-1 bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-100 px-4 py-2.5 rounded-xl text-sm font-bold transition-all active:scale-95 flex items-center justify-center gap-1">
                <i class="fas fa-file-csv"></i> CSV
              </button>
              <button onclick="downloadSalesReport('pdf')"
                class="flex-1 bg-rose-50 hover:bg-rose-100 text-rose-600 border border-rose-100 px-4 py-2.5 rounded-xl text-sm font-bold transition-all active:scale-95 flex items-center justify-center gap-1">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
            </div>
          </div>
        </div>

        <!-- Report Summary -->
        <div class="bg-white rounded-xl p-5 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
          <h4 class="text-slate-700 font-bold mb-4 flex items-center gap-2 text-sm">
            <i class="fas fa-info-circle text-slate-400"></i>
            Summary
          </h4>
          <div class="space-y-3 text-xs font-medium">
            <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg">
              <span class="text-slate-400">Last Generated</span>
              <span class="text-slate-700 font-bold" id="lastReportDate">Never</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg">
              <span class="text-slate-400">Total Exports</span>
              <span class="text-slate-700 font-bold" id="totalReports">0</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg">
              <span class="text-slate-400">Data Range</span>
              <span class="text-slate-700 font-bold" id="dataRange">All Time</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Revenue Chart -->
      <div class="glass rounded-[1.5rem] p-6 sm:p-8">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              Revenue Trend
              <span class="relative flex h-2 w-2">
                <span
                  class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
              </span>
            </h3>
            <p class="text-xs text-slate-400 font-medium mt-1">Earnings over time</p>
          </div>
          <div class="flex bg-slate-100 p-1 rounded-xl">
            <button
              class="px-3 py-1 text-xs font-bold text-slate-600 bg-white shadow-sm rounded-lg transition-all">7D</button>
            <button class="px-3 py-1 text-xs font-bold text-slate-400 hover:text-slate-600 transition-all">30D</button>
            <button class="px-3 py-1 text-xs font-bold text-slate-400 hover:text-slate-600 transition-all">90D</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>

      <!-- Phone Categories Chart -->
      <div class="glass rounded-[1.5rem] p-6 sm:p-8">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              Device Distribution
            </h3>
            <p class="text-xs text-slate-400 font-medium mt-1">Sales by brand/model</p>
          </div>
          <div class="w-8 h-8 rounded-lg bg-purple-50 text-purple-600 flex items-center justify-center">
            <i class="fas fa-chart-pie text-sm"></i>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Detailed Analytics -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Recent Invoices -->
      <div class="lg:col-span-2 glass rounded-[1.5rem] p-6 sm:p-8 overflow-hidden">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
          <div>
            <h3 class="text-lg font-bold text-slate-800">Recent Transactions</h3>
            <p class="text-xs text-slate-400 font-medium mt-1">Latest invoice activity</p>
          </div>

          <div class="flex items-center gap-2">
            <div class="relative">
              <input type="text" id="quickSearch" placeholder="Search..."
                class="search-enhanced py-2 px-3 pl-9 text-xs font-bold w-32 focus:w-48 placeholder:text-slate-400">
              <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-xs"></i>
            </div>

            <button id="filterToggle"
              class="bg-white border border-slate-200 text-slate-500 hover:text-slate-700 w-8 h-8 rounded-lg flex items-center justify-center transition-colors shadow-sm">
              <i class="fas fa-filter text-xs"></i>
            </button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead>
              <tr class="border-b border-slate-100">
                <th
                  class="py-3 px-2 text-[10px] uppercase tracking-wider font-bold text-slate-400 cursor-pointer hover:text-slate-600 transition-colors"
                  onclick="sortTable('invoice')">
                  ID <i class="fas fa-sort text-[8px] ml-1 opacity-50"></i>
                </th>
                <th
                  class="py-3 px-2 text-[10px] uppercase tracking-wider font-bold text-slate-400 cursor-pointer hover:text-slate-600 transition-colors"
                  onclick="sortTable('customer')">
                  Customer
                </th>
                <th
                  class="py-3 px-2 text-[10px] uppercase tracking-wider font-bold text-slate-400 cursor-pointer hover:text-slate-600 transition-colors"
                  onclick="sortTable('amount')">
                  Amount
                </th>
                <th
                  class="py-3 px-2 text-[10px] uppercase tracking-wider font-bold text-slate-400 cursor-pointer hover:text-slate-600 transition-colors"
                  onclick="sortTable('date')">
                  Date
                </th>
                <th class="py-3 px-2 text-[10px] uppercase tracking-wider font-bold text-slate-400">Status</th>
              </tr>
            </thead>
            <tbody id="recent-invoices" class="divide-y divide-slate-50">
              <tr>
                <td colspan="5" class="text-center py-12">
                  <div class="loading-spinner mx-auto mb-3"></div>
                  <span class="text-slate-400 text-xs font-bold">Syncing data...</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div id="paginationControls"
          class="hidden flex justify-between items-center mt-6 pt-4 border-t border-slate-100">
          <div class="text-xs font-bold text-slate-400" id="paginationInfo">
            Showing 0-0 of 0
          </div>
          <div class="flex gap-2">
            <button onclick="changePage(-1)"
              class="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 text-slate-500 rounded-lg text-xs hover:bg-slate-50 transition-all shadow-sm"
              disabled>
              <i class="fas fa-chevron-left"></i>
            </button>
            <button onclick="changePage(1)"
              class="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 text-slate-500 rounded-lg text-xs hover:bg-slate-50 transition-all shadow-sm"
              disabled>
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Top Phones -->
      <div class="glass rounded-[1.5rem] p-6 sm:p-8">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h3 class="text-lg font-bold text-slate-800">Top Performers</h3>
            <p class="text-xs text-slate-400 font-medium mt-1">Best selling devices</p>
          </div>
          <i class="fas fa-trophy text-amber-400 text-lg"></i>
        </div>
        <div class="space-y-4" id="top-phones">
          <div class="text-center py-8 text-slate-400 text-xs font-medium">
            <div class="loading-spinner mx-auto mb-3"></div>
            Loading rankings...
          </div>
        </div>
      </div>
    </div>

    <!-- Performance Insights -->
    <div class="glass rounded-[1.5rem] p-6 sm:p-8">
      <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
        <i class="fas fa-lightbulb text-yellow-500"></i> Business Insights
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div
          class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm text-center group hover:shadow-md transition-all">
          <div
            class="w-12 h-12 rounded-full bg-emerald-50 text-emerald-500 flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
            <i class="fas fa-trending-up text-xl"></i>
          </div>
          <h4 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Growth Rate</h4>
          <p class="text-2xl font-black text-slate-800" id="growth-rate">+0%</p>
          <p class="text-xs text-slate-400 mt-1">Monthly performance</p>
        </div>

        <div
          class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm text-center group hover:shadow-md transition-all">
          <div
            class="w-12 h-12 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
            <i class="fas fa-users text-xl"></i>
          </div>
          <h4 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Active Customers</h4>
          <p class="text-2xl font-black text-slate-800" id="customer-count">0</p>
          <p class="text-xs text-slate-400 mt-1">Total client base</p>
        </div>

        <div
          class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm text-center group hover:shadow-md transition-all">
          <div
            class="w-12 h-12 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
            <i class="fas fa-clock text-xl"></i>
          </div>
          <h4 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Avg Processing</h4>
          <p class="text-2xl font-black text-slate-800" id="avg-processing">~2m</p>
          <p class="text-xs text-slate-400 mt-1">Invoice generation time</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-auto py-8 text-center border-t border-slate-100 bg-white/50 backdrop-blur-sm">
    <div class="max-w-7xl mx-auto px-6">
      <p class="text-xs font-medium text-slate-400">
        © <span id="footer-year"></span> <span class="text-slate-800 font-bold">Dastelecom</span>. Analytics Dashboard.
      </p>
    </div>
  </footer>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAibWFQ955D9sxgExTvXf9ykC0HJQPbatA",
      authDomain: "dastelecominvoicegenerator.firebaseapp.com",
      databaseURL: "https://dastelecominvoicegenerator-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dastelecominvoicegenerator",
      storageBucket: "dastelecominvoicegenerator.appspot.com",
      messagingSenderId: "959180798639",
      appId: "1:959180798639:web:861d25289ff80c8c17725a",
      measurementId: "G-Y4JJXQGSJC"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Chart variables
    let revenueChart, categoryChart;

    // Update current time
    function updateTime() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleString();
    }

    // Function to update invoice status (Paid status is final)
    function updateInvoiceStatus(selectElement) {
      const invoiceNo = selectElement.dataset.invoice;
      const newStatus = selectElement.value;
      const statusKey = `invoice_status_${invoiceNo}`;
      const previousStatus = localStorage.getItem(statusKey) || 'pending';

      // Check if previous status was 'paid' - if so, prevent any changes
      if (previousStatus === 'paid') {
        showStatusChangeWarning(invoiceNo, 'This invoice is already marked as paid and cannot be changed.');
        selectElement.value = 'paid'; // Reset to paid
        return;
      }

      // Apply color styling based on status
      applyStatusColor(selectElement, newStatus);

      // Store the new status
      localStorage.setItem(statusKey, newStatus);

      // If status is now 'paid', disable further changes
      if (newStatus === 'paid') {
        selectElement.disabled = true;
        selectElement.style.opacity = '0.7';
        selectElement.style.cursor = 'not-allowed';

        // Mark as changed to prevent future modifications
        const changeKey = `invoice_changed_${invoiceNo}`;
        localStorage.setItem(changeKey, 'true');

        showStatusUpdateConfirmation(invoiceNo, newStatus, true); // true = final
      } else {
        showStatusUpdateConfirmation(invoiceNo, newStatus, false); // false = not final
      }

      console.log(`Invoice ${invoiceNo} status updated to: ${newStatus}`);
    }

    // Function to apply color styling to status select
    function applyStatusColor(selectElement, status) {
      // Remove all status classes
      selectElement.classList.remove('text-green-400', 'text-yellow-400', 'text-blue-400', 'text-emerald-500', 'text-amber-500', 'text-blue-500');

      // Apply color based on status
      switch (status) {
        case 'paid':
          selectElement.classList.add('text-emerald-500');
          break;
        case 'pending':
          selectElement.classList.add('text-amber-500');
          break;
        case 'processing':
          selectElement.classList.add('text-blue-500');
          break;
        default:
          selectElement.classList.add('text-amber-500'); // Default to pending
      }
    }

    // Function to apply colors to all status selects
    function applyStatusColors() {
      const statusSelects = document.querySelectorAll('.status-select');
      statusSelects.forEach(select => {
        const invoiceNo = select.dataset.invoice;
        const statusKey = `invoice_status_${invoiceNo}`;
        const savedStatus = localStorage.getItem(statusKey);

        if (savedStatus) {
          select.value = savedStatus;
        } else {
          // Default to 'pending' for new invoices
          select.value = 'pending';
        }

        // If status is 'paid', disable the select (paid is final)
        if (savedStatus === 'paid') {
          select.disabled = true;
          select.style.opacity = '0.7';
          select.style.cursor = 'not-allowed';
        }

        applyStatusColor(select, select.value);
      });
    }

    // Function to show status update confirmation
    function showStatusUpdateConfirmation(invoiceNo, status, isFinal = false) {
      // Create a temporary notification
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-white border border-slate-200 text-slate-800 px-6 py-4 rounded-xl shadow-2xl z-50 transition-all duration-300 transform translate-x-full';

      const finalText = isFinal ? '<div class="text-xs text-emerald-600 ml-2 font-bold">(FINAL - Cannot be changed)</div>' : '';

      notification.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center">
            <i class="fas fa-check text-emerald-600"></i>
          </div>
          <div>
            <p class="font-medium">Status Updated</p>
            <p class="text-sm text-slate-500">Invoice ${invoiceNo} is now <span class="font-bold text-slate-800">${status.toUpperCase()}</span></p>
          </div>
          ${finalText}
        </div>
      `;

      document.body.appendChild(notification);

      // Remove notification after 4 seconds (longer for final status)
      const timeout = isFinal ? 5000 : 3000;
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, timeout);
    }

    // Function to show warning when trying to change status again
    function showStatusChangeWarning(invoiceNo, customMessage = null) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-red-50 border border-red-100 text-red-800 px-6 py-4 rounded-xl shadow-2xl z-50 transition-all duration-300 transform translate-x-full';

      const message = customMessage || `Invoice ${invoiceNo} status cannot be changed again`;

      notification.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-red-600"></i>
          </div>
          <div>
            <p class="font-medium text-red-900">Action Denied</p>
            <p class="text-sm text-red-700">${message}</p>
          </div>
        </div>
      `;

      document.body.appendChild(notification);

      // Remove notification after 4 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 4000);
    }

    // Report System Functions
    let allInvoiceData = [];

    // Initialize report system
    function initializeReportSystem() {
      populateMonthSelector();
      updateReportSummary();
    }

    // Populate month selector with last 12 months
    function populateMonthSelector() {
      const monthSelector = document.getElementById('monthSelector');
      const currentDate = new Date();

      monthSelector.innerHTML = '<option value="all">All Time</option>';

      for (let i = 0; i < 12; i++) {
        const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
        const monthYear = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const value = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;

        const option = document.createElement('option');
        option.value = value;
        option.textContent = monthYear;
        monthSelector.appendChild(option);
      }
    }

    // Update report summary
    function updateReportSummary() {
      const lastReport = localStorage.getItem('lastReportDate');
      const totalReports = localStorage.getItem('totalReports') || '0';

      document.getElementById('lastReportDate').textContent = lastReport || 'Never';
      document.getElementById('totalReports').textContent = totalReports;

      if (allInvoiceData.length > 0) {
        const dates = allInvoiceData.map(inv => new Date(inv.date)).filter(d => !isNaN(d));
        if (dates.length > 0) {
          const minDate = new Date(Math.min(...dates));
          const maxDate = new Date(Math.max(...dates));
          document.getElementById('dataRange').textContent =
            `${minDate.toLocaleDateString()} - ${maxDate.toLocaleDateString()}`;
        }
      }
    }

    // Generate monthly report
    function generateMonthlyReport() {
      const selectedMonth = document.getElementById('monthSelector').value;

      if (allInvoiceData.length === 0) {
        showNotification('No data available for report generation', 'warning');
        return;
      }

      let filteredData = allInvoiceData;

      if (selectedMonth !== 'all') {
        const [year, month] = selectedMonth.split('-');
        filteredData = allInvoiceData.filter(invoice => {
          const invoiceDate = new Date(invoice.date);
          return invoiceDate.getFullYear() == year &&
            (invoiceDate.getMonth() + 1) == parseInt(month);
        });
      }

      if (filteredData.length === 0) {
        showNotification('No invoices found for selected period', 'warning');
        return;
      }

      generateReportModal(filteredData, selectedMonth);

      // Update report summary
      const currentDate = new Date().toLocaleDateString();
      localStorage.setItem('lastReportDate', currentDate);
      const totalReports = (parseInt(localStorage.getItem('totalReports') || '0') + 1).toString();
      localStorage.setItem('totalReports', totalReports);
      updateReportSummary();
    }

    // Generate report modal
    function generateReportModal(data, period) {
      const totalRevenue = data.reduce((sum, inv) => {
        return sum + (parseFloat(inv.total.toString().replace(/[^\d.]/g, '')) || 0);
      }, 0);

      const avgOrderValue = data.length > 0 ? totalRevenue / data.length : 0;
      const uniqueCustomers = new Set(data.map(inv => inv.name.toLowerCase())).size;

      const periodText = period === 'all' ? 'All Time' :
        new Date(period + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto border border-slate-200 shadow-2xl">
          <div class="flex items-center justify-between mb-6 border-b border-slate-100 pb-4">
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
              <span class="w-10 h-10 rounded-lg bg-orange-50 flex items-center justify-center text-orange-600">
                <i class="fas fa-chart-pie text-lg"></i>
              </span>
              Monthly Report - ${periodText}
            </h2>
            <button onclick="closeReportModal(this)" class="text-slate-400 hover:text-slate-600 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-50">
              <i class="fas fa-times text-lg"></i>
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
            <div class="bg-emerald-50/50 rounded-xl p-4 text-center border border-emerald-100">
              <div class="text-emerald-600 text-2xl font-black">₹${totalRevenue.toLocaleString('en-IN')}</div>
              <div class="text-emerald-800/60 text-xs font-bold uppercase tracking-wider mt-1">Total Revenue</div>
            </div>
            <div class="bg-blue-50/50 rounded-xl p-4 text-center border border-blue-100">
              <div class="text-blue-600 text-2xl font-black">${data.length}</div>
              <div class="text-blue-800/60 text-xs font-bold uppercase tracking-wider mt-1">Total Invoices</div>
            </div>
            <div class="bg-violet-50/50 rounded-xl p-4 text-center border border-violet-100">
              <div class="text-violet-600 text-2xl font-black">${uniqueCustomers}</div>
              <div class="text-violet-800/60 text-xs font-bold uppercase tracking-wider mt-1">Unique Customers</div>
            </div>
          </div>
          
          <div class="bg-slate-50 rounded-xl p-5 mb-6 border border-slate-100">
            <h3 class="text-slate-800 font-bold mb-4 flex items-center gap-2">
              <i class="fas fa-info-circle text-slate-400"></i> Key Metrics
            </h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-slate-100">
                <span class="text-slate-500 font-medium">Average Order Value</span>
                <span class="text-slate-800 font-bold">₹${Math.round(avgOrderValue).toLocaleString('en-IN')}</span>
              </div>
              <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-slate-100">
                <span class="text-slate-500 font-medium">Phones Sold</span>
                <span class="text-slate-800 font-bold">${data.length} units</span>
              </div>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button onclick="downloadReportData('${period}', 'csv')" class="flex-1 bg-white hover:bg-slate-50 border border-slate-200 text-slate-700 px-4 py-3 rounded-xl transition-all flex items-center justify-center gap-2 font-bold shadow-sm hover:shadow-md hover:-translate-y-0.5">
              <i class="fas fa-file-csv text-green-500 text-lg"></i>
              Download CSV
            </button>
            <button onclick="downloadReportData('${period}', 'pdf')" class="flex-1 bg-slate-900 hover:bg-slate-800 text-white px-4 py-3 rounded-xl transition-all flex items-center justify-center gap-2 font-bold shadow-lg shadow-slate-900/20 hover:-translate-y-0.5">
              <i class="fas fa-file-pdf text-red-400 text-lg"></i>
              Download PDF
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Close report modal
    function closeReportModal(button) {
      const modal = button.closest('.fixed');
      modal.remove();
    }

    // Download sales report
    function downloadSalesReport(format) {
      if (allInvoiceData.length === 0) {
        showNotification('No data available for download', 'warning');
        return;
      }

      downloadReportData('all', format);
    }

    // Download report data
    function downloadReportData(period, format) {
      let data = allInvoiceData;

      if (period !== 'all') {
        const [year, month] = period.split('-');
        data = allInvoiceData.filter(invoice => {
          const invoiceDate = new Date(invoice.date);
          return invoiceDate.getFullYear() == year &&
            (invoiceDate.getMonth() + 1) == parseInt(month);
        });
      }

      if (format === 'csv') {
        downloadCSV(data, period);
      } else if (format === 'pdf') {
        downloadPDF(data, period);
      }

      showNotification(`${format.toUpperCase()} report downloaded successfully!`, 'success');
    }

    // Download CSV
    function downloadCSV(data, period) {
      const headers = ['Invoice No', 'Customer Name', 'Date', 'Amount'];
      const csvContent = [
        headers.join(','),
        ...data.map(row => [
          row.invoiceNo,
          `"${row.name}"`,
          row.date,
          row.total
        ].join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `sales-report-${period}-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      window.URL.revokeObjectURL(url);
    }

    // Download PDF (simplified)
    function downloadPDF(data, period) {
      const totalRevenue = data.reduce((sum, inv) => {
        return sum + (parseFloat(inv.total.toString().replace(/[^\d.]/g, '')) || 0);
      }, 0);

      const periodText = period === 'all' ? 'All Time' :
        new Date(period + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      // Create a simple HTML content for PDF
      const htmlContent = `
        <html>
        <head>
          <title>Sales Report - ${periodText}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            h1 { color: #d97757; text-align: center; }
            .summary { background: #f5f5f5; padding: 15px; margin: 20px 0; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
          </style>
        </head>
        <body>
          <h1>Dastelecom Sales Report</h1>
          <h2>Period: ${periodText}</h2>
          <div class="summary">
            <p><strong>Total Revenue:</strong> ₹${totalRevenue.toLocaleString('en-IN')}</p>
            <p><strong>Total Invoices:</strong> ${data.length}</p>
            <p><strong>Phones Sold:</strong> ${data.length} units</p>
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
          </div>
          <table>
            <thead>
              <tr><th>Invoice No</th><th>Customer</th><th>Date</th><th>Amount</th></tr>
            </thead>
            <tbody>
              ${data.map(row => `
                <tr>
                  <td>${row.invoiceNo}</td>
                  <td>${row.name}</td>
                  <td>${row.date}</td>
                  <td>₹${parseFloat(row.total.toString().replace(/[^\d.]/g, '') || '0').toLocaleString('en-IN')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </body>
        </html>
      `;

      // Open in new window for printing/saving as PDF
      const printWindow = window.open('', '_blank');
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      printWindow.print();
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const colors = {
        success: 'bg-emerald-50 border-emerald-100 text-emerald-800',
        warning: 'bg-amber-50 border-amber-100 text-amber-800',
        error: 'bg-red-50 border-red-100 text-red-800',
        info: 'bg-blue-50 border-blue-100 text-blue-800'
      };

      const icons = {
        success: 'fa-check-circle text-emerald-500',
        warning: 'fa-exclamation-triangle text-amber-500',
        error: 'fa-times-circle text-red-500',
        info: 'fa-info-circle text-blue-500'
      };

      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 ${colors[type]} border px-6 py-4 rounded-xl shadow-xl z-50 transition-all duration-300 transform translate-x-full`;
      notification.innerHTML = `
        <div class="flex items-center gap-3">
          <i class="fas ${icons[type]} text-xl"></i>
          <span class="font-medium">${message}</span>
        </div>
      `;

      document.body.appendChild(notification);

      // Trigger animation
      requestAnimationFrame(() => {
        notification.classList.remove('translate-x-full');
      });

      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // Enhanced System Functions
    let currentPage = 1;
    let itemsPerPage = 5;
    let filteredInvoices = [];
    let sortColumn = '';
    let sortDirection = 'asc';

    // Initialize enhanced features
    function initializeEnhancedFeatures() {
      // Filter toggle
      document.getElementById('filterToggle').addEventListener('click', function () {
        const menu = document.getElementById('filterMenu');
        menu.classList.toggle('hidden');
      });

      // Quick search with debouncing
      const quickSearch = document.getElementById('quickSearch');
      if (quickSearch) {
        quickSearch.addEventListener('input', debounce(function (e) {
          performQuickSearch(e.target.value);
        }, 300));
      }

      // Close filter menu when clicking outside
      document.addEventListener('click', function (e) {
        const filterToggle = document.getElementById('filterToggle');
        const filterMenu = document.getElementById('filterMenu');
        if (!filterToggle.contains(e.target) && !filterMenu.contains(e.target)) {
          filterMenu.classList.add('hidden');
        }
      });
    }

    // Advanced filtering
    function applyFilters() {
      const statusFilter = document.getElementById('statusFilter').value;
      const minAmount = parseFloat(document.getElementById('minAmount').value) || 0;
      const maxAmount = parseFloat(document.getElementById('maxAmount').value) || Infinity;

      filteredInvoices = allInvoiceData.filter(invoice => {
        const amount = parseFloat(invoice.total.toString().replace(/[^\d.]/g, '')) || 0;
        const statusKey = `invoice_status_${invoice.invoiceNo}`;
        const currentStatus = localStorage.getItem(statusKey) || 'pending';

        const statusMatch = statusFilter === 'all' || currentStatus === statusFilter;
        const amountMatch = amount >= minAmount && amount <= maxAmount;

        return statusMatch && amountMatch;
      });

      currentPage = 1;
      displayFilteredInvoices();
      document.getElementById('filterMenu').classList.add('hidden');

      showNotification(`Applied filters: ${filteredInvoices.length} invoices found`, 'success');
    }

    // Quick search functionality
    function performQuickSearch(searchTerm) {
      if (!searchTerm.trim()) {
        filteredInvoices = [...allInvoiceData];
      } else {
        filteredInvoices = allInvoiceData.filter(invoice => {
          const searchLower = searchTerm.toLowerCase();
          return invoice.invoiceNo.toLowerCase().includes(searchLower) ||
            invoice.name.toLowerCase().includes(searchLower) ||
            invoice.date.toLowerCase().includes(searchLower);
        });
      }

      currentPage = 1;
      displayFilteredInvoices();
    }

    // Table sorting
    function sortTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }

      filteredInvoices.sort((a, b) => {
        let valueA, valueB;

        switch (column) {
          case 'invoice':
            valueA = parseInt(a.invoiceNo.replace(/\D/g, '')) || 0;
            valueB = parseInt(b.invoiceNo.replace(/\D/g, '')) || 0;
            break;
          case 'customer':
            valueA = a.name.toLowerCase();
            valueB = b.name.toLowerCase();
            break;
          case 'amount':
            valueA = parseFloat(a.total.toString().replace(/[^\d.]/g, '')) || 0;
            valueB = parseFloat(b.total.toString().replace(/[^\d.]/g, '')) || 0;
            break;
          case 'date':
            valueA = new Date(a.date);
            valueB = new Date(b.date);
            break;
          default:
            return 0;
        }

        if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
        if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });

      displayFilteredInvoices();

      // Update sort indicators
      document.querySelectorAll('th i').forEach(icon => {
        icon.className = 'fas fa-sort text-xs ml-1';
      });

      const activeHeader = document.querySelector(`th[onclick="sortTable('${column}')"] i`);
      if (activeHeader) {
        activeHeader.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'} text-xs ml-1`;
      }
    }

    // Display filtered invoices with pagination
    function displayFilteredInvoices() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageInvoices = filteredInvoices.slice(startIndex, endIndex);

      let invoicesHtml = '';

      if (pageInvoices.length === 0) {
        invoicesHtml = `
          <tr>
            <td colspan="5" class="text-center py-12 text-slate-400 text-sm font-medium">
              <div class="mb-3 transform scale-110 opacity-50">
                <i class="fas fa-search text-3xl text-slate-300"></i>
              </div>
              No invoices found matching your criteria
            </td>
          </tr>
        `;
      } else {
        invoicesHtml = pageInvoices.map((invoice, index) => {
          const statusKey = `invoice_status_${invoice.invoiceNo}`;
          const currentStatus = localStorage.getItem(statusKey) || 'pending';
          const isPaid = currentStatus === 'paid';

          return `
            <tr class="border-b border-slate-50 hover:bg-slate-50/80 transition-all duration-200 group" style="animation: fadeIn 0.3s ease forwards ${index * 0.05}s; opacity: 0;">
              <td class="py-4 px-2 font-mono text-xs font-bold text-blue-600 group-hover:text-blue-700 transition-colors">
                <span class="bg-blue-50 px-2 py-1 rounded-md border border-blue-100">${invoice.invoiceNo}</span>
              </td>
              <td class="py-4 px-2 text-slate-700 font-semibold text-sm group-hover:text-slate-900 transition-colors">${invoice.name}</td>
              <td class="py-4 px-2 font-black text-emerald-600">₹${parseFloat(invoice.total.toString().replace(/[^\d.]/g, '') || '0').toLocaleString('en-IN')}</td>
              <td class="py-4 px-2 text-slate-400 text-xs font-medium">${invoice.date}</td>
              <td class="py-4 px-2">
                <select class="status-select w-full bg-white border border-slate-200 rounded-lg px-3 py-1.5 text-xs font-bold shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all cursor-pointer hover:bg-slate-50" 
                        data-invoice="${invoice.invoiceNo}" 
                        onchange="updateInvoiceStatus(this)" ${isPaid ? 'disabled' : ''}>
                  <option value="pending" class="text-amber-500 font-bold">Pending</option>
                  <option value="processing" class="text-blue-500 font-bold">Processing</option>
                  <option value="paid" class="text-emerald-500 font-bold">Paid</option>
                </select>
              </td>
            </tr>
          `;
        }).join('');
      }

      document.getElementById('recent-invoices').innerHTML = invoicesHtml;

      // Apply status colors and states
      setTimeout(() => {
        applyStatusColors();
        updatePagination();
      }, 100);
    }

    // Pagination controls
    function updatePagination() {
      const totalPages = Math.ceil(filteredInvoices.length / itemsPerPage);
      const paginationControls = document.getElementById('paginationControls');
      const paginationInfo = document.getElementById('paginationInfo');

      if (totalPages > 1) {
        paginationControls.classList.remove('hidden');

        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, filteredInvoices.length);

        paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${filteredInvoices.length} invoices`;

        // Update button states
        const prevBtn = paginationControls.querySelector('button:first-of-type');
        const nextBtn = paginationControls.querySelector('button:last-of-type');

        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;

        prevBtn.className = `px-3 py-1 text-white rounded text-sm transition-all ${currentPage === 1 ? 'bg-gray-800 cursor-not-allowed' : 'bg-gray-700 hover:bg-gray-600'
          }`;

        nextBtn.className = `px-3 py-1 text-white rounded text-sm transition-all ${currentPage === totalPages ? 'bg-gray-800 cursor-not-allowed' : 'bg-gray-700 hover:bg-gray-600'
          }`;
      } else {
        paginationControls.classList.add('hidden');
      }
    }

    // Change page function
    function changePage(direction) {
      const totalPages = Math.ceil(filteredInvoices.length / itemsPerPage);
      const newPage = currentPage + direction;

      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        displayFilteredInvoices();
      }
    }

    // Set current year in footer
    document.getElementById('footer-year').textContent = new Date().getFullYear();

    // Initialize charts
    function initCharts() {
      // Revenue Chart
      const revenueCtx = document.getElementById('revenueChart').getContext('2d');
      revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [{
            label: 'Revenue',
            data: [12000, 15000, 18000, 22000, 19000, 25000],
            borderColor: 'rgb(37, 99, 235)', // blue-600
            backgroundColor: 'rgba(37, 99, 235, 0.05)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#ffffff',
            pointBorderColor: 'rgb(37, 99, 235)',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#64748b', // slate-500
                font: {
                  family: "'Outfit', sans-serif",
                  weight: '600'
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: '#f1f5f9' // slate-100
              },
              ticks: {
                color: '#64748b', // slate-500
                font: {
                  family: "'Outfit', sans-serif"
                },
                callback: function (value) {
                  return '₹' + value.toLocaleString('en-IN');
                }
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#64748b', // slate-500
                font: {
                  family: "'Outfit', sans-serif"
                }
              }
            }
          }
        }
      });

      // Category Chart
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: ['Vivo', 'Oppo', 'Samsung', 'Realme'],
          datasets: [{
            data: [35, 25, 30, 10],
            backgroundColor: [
              'rgba(59, 130, 246, 0.9)', // blue-500
              'rgba(16, 185, 129, 0.9)', // emerald-500
              'rgba(245, 158, 11, 0.9)', // amber-500
              'rgba(139, 92, 246, 0.9)'  // violet-500
            ],
            borderColor: '#ffffff',
            borderWidth: 2,
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#64748b', // slate-500
                padding: 20,
                usePointStyle: true,
                font: {
                  family: "'Outfit', sans-serif",
                  weight: '500'
                }
              }
            }
          },
          cutout: '75%'
        }
      });
    }

    // Load analytics data
    function loadAnalyticsData() {
      // Animate customer count from 0 to 100000+
      animateCustomerCount();

      // Initialize report system
      initializeReportSystem();

      // Initialize enhanced features
      initializeEnhancedFeatures();

      // Load recent invoices with real data
      loadRecentInvoices();
    }

    // Animate customer base counter from 0 to 100000+
    function animateCustomerCount() {
      const customerElement = document.getElementById('customer-count');
      const targetValue = 100000;
      const duration = 2000; // 2 seconds
      const startTime = performance.now();

      // Set initial value
      customerElement.textContent = '0';

      function updateCount(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // Use easing function for smooth animation
        const easedProgress = easeOutExpo(progress);
        const currentValue = Math.floor(targetValue * easedProgress);

        // Format number with commas and add animation effect
        if (currentValue < targetValue) {
          customerElement.textContent = currentValue.toLocaleString('en-IN');
          customerElement.style.transform = `scale(${1 + (Math.sin(progress * Math.PI * 10) * 0.02)})`;
        } else {
          // Final state with 100000+ format
          customerElement.textContent = '100000+';
          customerElement.style.transform = 'scale(1)';

          // Add a subtle glow effect when animation completes
          customerElement.style.textShadow = '0 0 10px rgba(217, 119, 87, 0.5)';
          setTimeout(() => {
            customerElement.style.textShadow = '';
          }, 1000);
        }

        // Continue animation if not complete
        if (progress < 1) {
          requestAnimationFrame(updateCount);
        }
      }

      // Start the animation
      requestAnimationFrame(updateCount);
    }

    // Easing function for smooth animation
    function easeOutExpo(t) {
      return t === 1 ? 1 : 1 - Math.pow(2, -10 * t);
    }

    // Generic metric animation function
    function animateMetric(elementId, targetValue, delay = 0, prefix = '', useCommas = false) {
      setTimeout(() => {
        const element = document.getElementById(elementId);
        if (!element) return;

        const duration = 1500; // 1.5 seconds
        const startTime = performance.now();

        // Set initial value
        element.textContent = prefix + '0';

        function updateMetric(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);

          // Use easing function for smooth animation
          const easedProgress = easeOutExpo(progress);
          const currentValue = Math.floor(targetValue * easedProgress);

          // Format number based on preferences
          let displayValue;
          if (useCommas) {
            displayValue = prefix + currentValue.toLocaleString('en-IN');
          } else {
            displayValue = prefix + currentValue;
          }

          element.textContent = displayValue;

          // Add subtle scale animation
          element.style.transform = `scale(${1 + (Math.sin(progress * Math.PI * 8) * 0.015)})`;

          // Continue animation if not complete
          if (progress < 1) {
            requestAnimationFrame(updateMetric);
          } else {
            // Reset transform when complete
            element.style.transform = 'scale(1)';

            // Add completion glow effect
            element.style.transition = 'text-shadow 0.5s ease';
            element.style.textShadow = '0 0 8px rgba(217, 119, 87, 0.4)';
            setTimeout(() => {
              element.style.textShadow = '';
            }, 800);
          }
        }

        // Start the animation
        requestAnimationFrame(updateMetric);
      }, delay);
    }

    // Load recent invoices from Google Sheets (same source as invoice-pdfs.html)
    function loadRecentInvoices() {
      const sheetURL = "https://docs.google.com/spreadsheets/d/1PNLHAqcicex9EZxoaXL6xLuu4iSzWFDyot_ab1wsc5E/gviz/tq?tqx=out:json";

      fetch(sheetURL)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substr(47).slice(0, -2));
          const rows = json.table.rows;

          const invoices = [];

          rows.forEach((row, i) => {
            const cells = row.c;
            if (!cells) return;

            // Safely extract cell values with better fallbacks
            const invoiceNo = (cells[0] && cells[0].v !== null && cells[0].v !== undefined) ? String(cells[0].v) : "";
            const name = (cells[1] && cells[1].v !== null && cells[1].v !== undefined) ? String(cells[1].v) : "";

            // Handle date formatting from Google Sheets
            let date = "";
            if (cells[2]) {
              // Check if the cell exists but is empty
              if (cells[2].v === null || cells[2].v === undefined || cells[2].v === '') {
                date = "";
              } else {
                const dateValue = cells[2].v;

                // If it's a date object from Google Sheets, format it properly
                if (typeof dateValue === 'object') {
                  // Use the formatted value if available, otherwise process the raw value
                  if (dateValue.f) {
                    date = dateValue.f; // Formatted date string
                  } else if (dateValue.v) {
                    // Handle the raw date value if formatted is not available
                    const rawDateValue = dateValue.v;
                    if (typeof rawDateValue === 'string' && rawDateValue.startsWith('Date(')) {
                      try {
                        // Parse the Date() string
                        const dateMatch = rawDateValue.match(/Date\((\d+),(\d+),(\d+)\)/);
                        if (dateMatch) {
                          const year = parseInt(dateMatch[1]);
                          const month = parseInt(dateMatch[2]);
                          const day = parseInt(dateMatch[3]);
                          // Note: JavaScript months are 0-indexed
                          const dateObj = new Date(year, month, day);
                          const formattedDay = String(dateObj.getDate()).padStart(2, '0');
                          const formattedMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
                          const formattedYear = dateObj.getFullYear();
                          date = `${formattedDay}-${formattedMonth}-${formattedYear}`;
                        } else {
                          date = rawDateValue;
                        }
                      } catch (e) {
                        date = rawDateValue;
                      }
                    } else {
                      date = String(rawDateValue);
                    }
                  }
                } else if (typeof dateValue === 'string') {
                  // Check if it's a Date() string like "Date(2025,5,10)"
                  if (dateValue.startsWith('Date(')) {
                    try {
                      // Parse the Date() string
                      const dateMatch = dateValue.match(/Date\((\d+),(\d+),(\d+)\)/);
                      if (dateMatch) {
                        const year = parseInt(dateMatch[1]);
                        const month = parseInt(dateMatch[2]);
                        const day = parseInt(dateMatch[3]);
                        // Note: JavaScript months are 0-indexed, so we don't need to subtract 1
                        const dateObj = new Date(year, month, day);
                        const formattedDay = String(dateObj.getDate()).padStart(2, '0');
                        const formattedMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const formattedYear = dateObj.getFullYear();
                        date = `${formattedDay}-${formattedMonth}-${formattedYear}`;
                      } else {
                        date = dateValue;
                      }
                    } catch (e) {
                      date = dateValue;
                    }
                  } else {
                    date = dateValue;
                  }
                } else if (typeof dateValue === 'number') {
                  // Convert Google Sheets serial date number to actual date
                  const dateObj = new Date((dateValue - 25569) * 86400 * 1000);
                  const day = String(dateObj.getDate()).padStart(2, '0');
                  const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                  const year = dateObj.getFullYear();
                  date = `${day}-${month}-${year}`;
                } else {
                  // Handle other types
                  date = String(dateValue);
                }
              }
            }

            const total = (cells[3] && cells[3].v !== null && cells[3].v !== undefined) ? String(cells[3].v) : "";

            if (!invoiceNo && !name && !date) return;

            invoices.push({
              invoiceNo,
              name,
              date,
              total
            });
          });

          // Debug: Log the invoices data
          console.log("Invoices data:", invoices);
          console.log("Total invoices count:", invoices.length);

          // Store data for reports and enhanced features
          allInvoiceData = [...invoices];
          filteredInvoices = [...invoices];
          updateReportSummary();

          // Sort by invoice number (assuming newer invoices have higher numbers) and take latest 5
          const recentInvoices = invoices
            .sort((a, b) => {
              const numA = parseInt(a.invoiceNo.replace(/\D/g, '')) || 0;
              const numB = parseInt(b.invoiceNo.replace(/\D/g, '')) || 0;
              return numB - numA;
            })
            .slice(0, 5);

          // Calculate metrics for current month
          const now = new Date();
          const currentMonth = now.getMonth();
          const currentYear = now.getFullYear();

          const currentMonthInvoices = invoices.filter(invoice => {
            // Try to parse the formatted date back to a date object
            if (!invoice.date) return false;

            // Handle different date formats
            let invoiceDate;

            // Check if it's a Date() string like "Date(2025,5,10)"
            if (typeof invoice.date === 'string' && invoice.date.startsWith('Date(')) {
              try {
                const dateMatch = invoice.date.match(/Date\((\d+),(\d+),(\d+)\)/);
                if (dateMatch) {
                  const year = parseInt(dateMatch[1]);
                  const month = parseInt(dateMatch[2]);
                  const day = parseInt(dateMatch[3]);
                  invoiceDate = new Date(year, month, day);
                }
              } catch (e) {
                return false;
              }
            }
            // Check if it's in DD-MM-YYYY format
            else if (typeof invoice.date === 'string' && invoice.date.includes('-')) {
              const parts = invoice.date.split('-');
              if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Months are 0-indexed in JS
                const year = parseInt(parts[2]);
                invoiceDate = new Date(year, month, day);
              }
            }
            // Check if it's in MM/DD/YYYY format
            else if (typeof invoice.date === 'string' && invoice.date.includes('/')) {
              const parts = invoice.date.split('/');
              if (parts.length === 3) {
                const month = parseInt(parts[0]) - 1; // Months are 0-indexed in JS
                const day = parseInt(parts[1]);
                const year = parseInt(parts[2]);
                invoiceDate = new Date(year, month, day);
              }
            }
            // Try to parse as a standard date string
            else {
              invoiceDate = new Date(invoice.date);
            }

            // Check if date is valid
            if (!invoiceDate || isNaN(invoiceDate.getTime())) return false;

            return invoiceDate.getMonth() === currentMonth &&
              invoiceDate.getFullYear() === currentYear;
          });

          // Calculate metrics for previous month
          const previousMonth = currentMonth === 0 ? 11 : currentMonth - 1;
          const previousYear = currentMonth === 0 ? currentYear - 1 : currentYear;

          const previousMonthInvoices = invoices.filter(invoice => {
            // Try to parse the formatted date back to a date object
            if (!invoice.date) return false;

            // Handle different date formats
            let invoiceDate;

            // Check if it's a Date() string like "Date(2025,5,10)"
            if (typeof invoice.date === 'string' && invoice.date.startsWith('Date(')) {
              try {
                const dateMatch = invoice.date.match(/Date\((\d+),(\d+),(\d+)\)/);
                if (dateMatch) {
                  const year = parseInt(dateMatch[1]);
                  const month = parseInt(dateMatch[2]);
                  const day = parseInt(dateMatch[3]);
                  invoiceDate = new Date(year, month, day);
                }
              } catch (e) {
                return false;
              }
            }
            // Check if it's in DD-MM-YYYY format
            else if (typeof invoice.date === 'string' && invoice.date.includes('-')) {
              const parts = invoice.date.split('-');
              if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Months are 0-indexed in JS
                const year = parseInt(parts[2]);
                invoiceDate = new Date(year, month, day);
              }
            }
            // Check if it's in MM/DD/YYYY format
            else if (typeof invoice.date === 'string' && invoice.date.includes('/')) {
              const parts = invoice.date.split('/');
              if (parts.length === 3) {
                const month = parseInt(parts[0]) - 1; // Months are 0-indexed in JS
                const day = parseInt(parts[1]);
                const year = parseInt(parts[2]);
                invoiceDate = new Date(year, month, day);
              }
            }
            // Try to parse as a standard date string
            else {
              invoiceDate = new Date(invoice.date);
            }

            // Check if date is valid
            if (!invoiceDate || isNaN(invoiceDate.getTime())) return false;

            return invoiceDate.getMonth() === previousMonth &&
              invoiceDate.getFullYear() === previousYear;
          });

          // Update total invoices count with trend
          const totalInvoices = invoices.length;
          const invoicesThisMonth = currentMonthInvoices.length;
          const invoicesLastMonth = previousMonthInvoices.length;
          const invoiceTrend = invoicesLastMonth > 0 ?
            Math.round(((invoicesThisMonth - invoicesLastMonth) / invoicesLastMonth) * 100) :
            (invoicesThisMonth > 0 ? 100 : 0);

          // Debug: Log the calculated metrics
          console.log("Total invoices:", totalInvoices);
          console.log("Current month invoices:", invoicesThisMonth);
          console.log("Previous month invoices:", invoicesLastMonth);
          console.log("Invoice trend:", invoiceTrend);

          // Remove direct assignment since animateMetric will handle it
          // document.getElementById('total-invoices').textContent = totalInvoices.toLocaleString('en-IN');
          document.getElementById('invoice-trend').innerHTML = `${invoiceTrend >= 0 ? '+' : ''}${invoiceTrend}%`;
          document.getElementById('invoice-trend').className = invoiceTrend >= 0 ? 'trend-up' : 'trend-down';

          // Calculate total revenue
          const totalRevenue = invoices.reduce((sum, invoice) => {
            const amount = parseFloat(invoice.total.toString().replace(/[^\d.]/g, '')) || 0;
            return sum + amount;
          }, 0);

          // Calculate phones sold (assuming each invoice represents one phone sale)
          // But also calculate based on products if available in future
          const phonesSold = invoices.length;
          const phonesSoldThisMonth = currentMonthInvoices.length;
          const phonesSoldLastMonth = previousMonthInvoices.length;
          const phonesTrend = phonesSoldLastMonth > 0 ?
            Math.round(((phonesSoldThisMonth - phonesSoldLastMonth) / phonesSoldLastMonth) * 100) :
            (phonesSoldThisMonth > 0 ? 100 : 0);

          // Debug: Log phone metrics
          console.log("Phones sold:", phonesSold);
          console.log("Phones trend:", phonesTrend);

          // Remove direct assignment since animateMetric will handle it
          // document.getElementById('phones-sold').textContent = phonesSold.toLocaleString('en-IN');
          document.getElementById('phones-trend').innerHTML = `${phonesTrend >= 0 ? '+' : ''}${phonesTrend}`;
          document.getElementById('phones-trend').className = phonesTrend >= 0 ? 'trend-up' : 'trend-down';

          // Calculate average order value with trend
          const avgOrderValue = phonesSold > 0 ? totalRevenue / phonesSold : 0;
          const avgOrderValueThisMonth = phonesSoldThisMonth > 0 ?
            currentMonthInvoices.reduce((sum, invoice) => {
              const amount = parseFloat(invoice.total.toString().replace(/[^\d.]/g, '')) || 0;
              return sum + amount;
            }, 0) / phonesSoldThisMonth : 0;

          const avgOrderValueLastMonth = phonesSoldLastMonth > 0 ?
            previousMonthInvoices.reduce((sum, invoice) => {
              const amount = parseFloat(invoice.total.toString().replace(/[^\d.]/g, '')) || 0;
              return sum + amount;
            }, 0) / phonesSoldLastMonth : 0;

          const avgTrend = avgOrderValueLastMonth > 0 ?
            Math.round(((avgOrderValueThisMonth - avgOrderValueLastMonth) / avgOrderValueLastMonth) * 100) :
            (avgOrderValueThisMonth > 0 ? 100 : 0);

          // Debug: Log average order value metrics
          console.log("Average order value:", avgOrderValue);
          console.log("Average order value trend:", avgTrend);

          // Animate metrics with staggered timing
          animateMetric('total-revenue', totalRevenue, 0, '₹', true);
          animateMetric('total-invoices', totalInvoices, 300, '', true);
          animateMetric('phones-sold', phonesSold, 600, '', true);
          animateMetric('avg-order', Math.round(avgOrderValue), 900, '₹', true);

          // Update trend indicators
          document.getElementById('revenue-trend').innerHTML = `${invoiceTrend >= 0 ? '+' : ''}${invoiceTrend}%`;
          document.getElementById('revenue-trend').className = invoiceTrend >= 0 ? 'trend-up' : 'trend-down';
          document.getElementById('avg-trend').innerHTML = `${avgTrend >= 0 ? '+' : ''}${avgTrend}%`;
          document.getElementById('avg-trend').className = avgTrend >= 0 ? 'trend-up' : 'trend-down';

          // Update customer count (set to 100000+ as requested)
          document.getElementById('customer-count').textContent = '100000+';

          // Generate HTML for recent invoices
          let invoicesHtml = '';

          if (recentInvoices.length === 0) {
            invoicesHtml = `
              <tr>
                <td colspan="5" class="text-center py-8 text-gray-400">
                  <i class="fas fa-inbox text-3xl mb-3 block"></i>
                  No invoices found
                </td>
              </tr>
            `;
          } else {
            invoicesHtml = recentInvoices.map((invoice, index) => {
              // Format the total amount properly
              const amount = parseFloat(invoice.total.toString().replace(/[^\d.]/g, '')) || 0;
              // Format without unnecessary decimal places
              const formattedAmount = amount % 1 === 0 ?
                amount.toLocaleString('en-IN') :
                amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

              return `
                <tr class="border-b border-gray-700/50 hover:bg-gray-700/20 transition-colors">
                  <td class="py-3 text-blue-400 font-mono">${invoice.invoiceNo}</td>
                  <td class="py-3 text-white">${invoice.name}</td>
                  <td class="py-3 text-green-400 font-semibold">₹${formattedAmount}</td>
                  <td class="py-3 text-gray-300">${invoice.date}</td>
                  <td class="py-3">
                    <select class="status-select bg-gray-700/50 border border-gray-600 rounded-md px-2 py-1 text-xs font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" 
                            data-invoice="${invoice.invoiceNo}" 
                            onchange="updateInvoiceStatus(this)">
                      <option value="pending" class="bg-gray-800 text-yellow-400">Pending</option>
                      <option value="processing" class="bg-gray-800 text-blue-400">Processing</option>
                      <option value="paid" class="bg-gray-800 text-green-400">Paid</option>
                    </select>
                  </td>
                </tr>
              `;
            }).join('');
          }

          document.getElementById('recent-invoices').innerHTML = invoicesHtml;

          // Apply status colors after elements are added to DOM
          setTimeout(() => {
            applyStatusColors();
          }, 100);

          // Update charts and top phones with the new data
          setTimeout(() => {
            updateRevenueChart(invoices);
            updateCategoryChart(invoices);
            loadTopPhones(invoices);
          }, 500);
        })
        .catch(err => {
          console.error("Error loading invoices:", err);
          document.getElementById('recent-invoices').innerHTML = `
            <tr>
              <td colspan="5" class="text-center py-8 text-red-400">
                <i class="fas fa-exclamation-triangle text-2xl mb-2 block"></i>
                Error loading invoice data
              </td>
            </tr>
          `;
        });
    }

    // Load top phones based on actual data
    function loadTopPhones(invoices) {
      // For now, we'll use static data since we don't have product information in the spreadsheet
      const phonesHtml = `
        <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl shadow-sm hover:shadow-md transition-shadow group">
          <div class="flex items-center space-x-4">
            <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600 font-bold text-lg group-hover:scale-110 transition-transform">1</div>
            <div>
              <p class="text-slate-800 font-bold">iPhone 15 Pro</p>
              <p class="text-slate-400 text-xs">24 units sold</p>
            </div>
          </div>
          <span class="text-slate-800 font-bold bg-slate-50 px-3 py-1 rounded-lg border border-slate-100">₹1.25L</span>
        </div>
        
        <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl shadow-sm hover:shadow-md transition-shadow group">
          <div class="flex items-center space-x-4">
            <div class="w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-600 font-bold text-lg group-hover:scale-110 transition-transform">2</div>
            <div>
              <p class="text-slate-800 font-bold">Samsung S24</p>
              <p class="text-slate-400 text-xs">18 units sold</p>
            </div>
          </div>
          <span class="text-slate-800 font-bold bg-slate-50 px-3 py-1 rounded-lg border border-slate-100">₹85k</span>
        </div>
        
        <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl shadow-sm hover:shadow-md transition-shadow group">
          <div class="flex items-center space-x-4">
            <div class="w-10 h-10 rounded-lg bg-amber-50 flex items-center justify-center text-amber-600 font-bold text-lg group-hover:scale-110 transition-transform">3</div>
            <div>
              <p class="text-slate-800 font-bold">OnePlus 12</p>
              <p class="text-slate-400 text-xs">15 units sold</p>
            </div>
          </div>
          <span class="text-slate-800 font-bold bg-slate-50 px-3 py-1 rounded-lg border border-slate-100">₹65k</span>
        </div>
        
        <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl shadow-sm hover:shadow-md transition-shadow group">
          <div class="flex items-center space-x-4">
            <div class="w-10 h-10 rounded-lg bg-violet-50 flex items-center justify-center text-violet-600 font-bold text-lg group-hover:scale-110 transition-transform">4</div>
            <div>
              <p class="text-slate-800 font-bold">Pixel 8 Pro</p>
              <p class="text-slate-400 text-xs">10 units sold</p>
            </div>
          </div>
          <span class="text-slate-800 font-bold bg-slate-50 px-3 py-1 rounded-lg border border-slate-100">₹75k</span>
        </div>
      `;
      document.getElementById('top-phones').innerHTML = phonesHtml;
    }

    // Update revenue chart with actual data
    function updateRevenueChart(invoices) {
      if (!revenueChart) return;

      // Group invoices by month
      const monthlyRevenue = {};

      invoices.forEach(invoice => {
        if (!invoice.date) return;

        // Parse date
        let invoiceDate;
        if (typeof invoice.date === 'string' && invoice.date.startsWith('Date(')) {
          try {
            const dateMatch = invoice.date.match(/Date\((\d+),(\d+),(\d+)\)/);
            if (dateMatch) {
              const year = parseInt(dateMatch[1]);
              const month = parseInt(dateMatch[2]);
              const day = parseInt(dateMatch[3]);
              invoiceDate = new Date(year, month, day);
            }
          } catch (e) {
            return;
          }
        } else if (typeof invoice.date === 'string' && invoice.date.includes('-')) {
          const parts = invoice.date.split('-');
          if (parts.length === 3) {
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const year = parseInt(parts[2]);
            invoiceDate = new Date(year, month, day);
          }
        } else if (typeof invoice.date === 'string' && invoice.date.includes('/')) {
          const parts = invoice.date.split('/');
          if (parts.length === 3) {
            const month = parseInt(parts[0]) - 1;
            const day = parseInt(parts[1]);
            const year = parseInt(parts[2]);
            invoiceDate = new Date(year, month, day);
          }
        } else {
          invoiceDate = new Date(invoice.date);
        }

        if (!invoiceDate || isNaN(invoiceDate.getTime())) return;

        // Format as "MMM YYYY" for grouping
        const monthKey = invoiceDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

        // Parse amount
        const amount = parseFloat(invoice.total.toString().replace(/[^\d.]/g, '')) || 0;

        if (!monthlyRevenue[monthKey]) {
          monthlyRevenue[monthKey] = 0;
        }
        monthlyRevenue[monthKey] += amount;
      });

      // Convert to chart data
      const labels = Object.keys(monthlyRevenue);
      const data = Object.values(monthlyRevenue);

      // Update chart
      revenueChart.data.labels = labels;
      revenueChart.data.datasets[0].data = data;
      revenueChart.update();
    }

    // Update category chart with actual data
    function updateCategoryChart(invoices) {
      if (!categoryChart) return;

      // For now, we'll use static data since we don't have product category information
      // In a real implementation, this would analyze the invoices to determine category distribution
      categoryChart.data.labels = ['Vivo', 'Oppo', 'Samsung', 'Realme'];
      categoryChart.data.datasets[0].data = [35, 25, 30, 10];
      categoryChart.update();
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function () {
      updateTime();
      setInterval(updateTime, 1000);

      // Initialize charts after a short delay for better performance
      setTimeout(() => {
        initCharts();
        startRealTimeUpdates();
      }, 500);

      // Load data with performance monitoring
      const startTime = performance.now();
      loadAnalyticsData();

      // Log performance metrics
      setTimeout(() => {
        const loadTime = performance.now() - startTime;
        console.log(`Analytics loaded in ${loadTime.toFixed(2)}ms`);
      }, 2000);
    });

    // Real-time update system
    function startRealTimeUpdates() {
      // Update data every 30 seconds
      setInterval(() => {
        if (document.visibilityState === 'visible') {
          refreshMetrics();
        }
      }, 30000);

      // Update charts every 60 seconds
      setInterval(() => {
        if (document.visibilityState === 'visible') {
          updateChartData();
        }
      }, 60000);
    }

    // Enhanced refresh metrics with animation
    function refreshMetrics() {
      const metrics = ['total-revenue', 'total-invoices', 'phones-sold', 'avg-order'];

      metrics.forEach((metricId, index) => {
        setTimeout(() => {
          const element = document.getElementById(metricId);
          if (element) {
            element.style.transform = 'scale(1.05)';
            element.style.transition = 'transform 0.3s ease';

            setTimeout(() => {
              element.style.transform = 'scale(1)';
            }, 300);
          }
        }, index * 100);
      });

      // Refresh invoice data
      if (allInvoiceData.length > 0) {
        loadRecentInvoices();
      }
    }

    // Update chart data dynamically
    function updateChartData() {
      if (revenueChart && allInvoiceData.length > 0) {
        // Simulate real-time data updates
        const currentData = revenueChart.data.datasets[0].data;
        const newValue = currentData[currentData.length - 1] + Math.random() * 5000 - 2500;

        // Add new data point
        revenueChart.data.datasets[0].data.push(Math.max(0, newValue));
        revenueChart.data.labels.push(new Date().toLocaleTimeString());

        // Keep only last 10 data points
        if (revenueChart.data.datasets[0].data.length > 10) {
          revenueChart.data.datasets[0].data.shift();
          revenueChart.data.labels.shift();
        }

        revenueChart.update('none'); // Smooth update without animation
      }
    }

    // Performance optimization: Debounced search
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Enhanced error handling
    function handleError(error, context) {
      console.error(`Error in ${context}:`, error);
      showNotification(`Error: ${error.message || 'Something went wrong'}`, 'error');
    }

    // Memory management
    function cleanupResources() {
      if (revenueChart) {
        revenueChart.destroy();
      }
      if (categoryChart) {
        categoryChart.destroy();
      }
    }

    // Handle page visibility for performance
    document.addEventListener('visibilitychange', function () {
      if (document.visibilityState === 'hidden') {
        // Pause updates when page is not visible
        console.log('Page hidden - pausing updates');
      } else {
        // Resume updates when page becomes visible
        console.log('Page visible - resuming updates');
        refreshMetrics();
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', cleanupResources);
  </script>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/service-worker.js")
        .then(() => console.log("Service Worker Registered"));
    }
  </script>
</body>

</html>